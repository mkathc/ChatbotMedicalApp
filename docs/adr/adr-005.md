# ADR-005: Triaje offline — motor local mínimo y degradación elegante

## Estado
Propuesto (PoC)

## Contexto
El enunciado del reto establece explícitamente que el **triaje inicial debe operar incluso cuando no hay conectividad**. La aplicación está diseñada para uso móvil, donde son comunes escenarios de:
- red intermitente (3G),
- latencia elevada,
- ausencia total de conexión.

Al mismo tiempo:
- el triaje no debe realizar diagnósticos médicos definitivos,
- el sistema debe manejar datos sensibles (PHI),
- la IA avanzada (LLM) se ejecuta en backend mediante un BFF en producción.

Por ello, se requiere definir qué capacidades de triaje viven **on-device** y cómo se degrada el sistema cuando servicios externos no están disponibles.

## Decisión
Implementar un **motor de triaje offline mínimo** en el cliente móvil, basado en reglas determinísticas simples, complementado por una estrategia de **degradación elegante** cuando la conectividad o la IA no están disponibles.

### 1) Triaje offline determinístico (mínimo viable)
El cliente móvil incluye un motor local capaz de:
- clasificar síntomas en una de tres categorías:
    - **Emergencia**
    - **Requiere cita médica**
    - **Autocuidado**
- utilizar un conjunto reducido de reglas explícitas (árbol de decisión simple).

Este motor:
- no depende de IA generativa,
- no requiere acceso a red,
- es totalmente determinístico y testeable,
- está diseñado para ser compartido entre Android e iOS (visión KMP).

### 2) Alcance limitado en modo offline
En modo offline, el triaje:
- **solo clasifica** y comunica la recomendación general,
- no ofrece recomendaciones médicas detalladas,
- explica explícitamente sus limitaciones (“esto no es un diagnóstico”).

Ejemplo de salida offline:
> “Según la información proporcionada, esto puede ser una urgencia. Te recomendamos acudir a un servicio de emergencias.”

### 3) Degradación elegante
Cuando:
- el backend,
- el proveedor de IA,
- o la red
  no están disponibles, el sistema:

- utiliza el motor local de triaje,
- deshabilita o posterga capacidades no críticas (ej. consulta de historial),
- informa al usuario del estado (“funcionalidad limitada por conectividad”).

### 4) Integración con el modelo híbrido
- En **modo online**, el backend/BFF puede enriquecer el triaje con:
    - mejor interpretación de lenguaje natural,
    - mayor contextualización,
    - sugerencias más completas.
- En **modo offline**, el cliente mantiene funcionalidad mínima segura y útil.

## Alternativas consideradas

### A) Triaje 100% online
**Pros**
- Menor lógica en el cliente.
- Reglas centralizadas.

**Contras**
- No cumple el requisito de operación offline.
- Riesgo alto en escenarios críticos sin conectividad.
- Mala experiencia móvil.

---

### B) IA local completa en el dispositivo
**Pros**
- Independencia total de red.

**Contras**
- Alto costo computacional.
- Complejidad excesiva para PoC.
- Riesgos adicionales de validación clínica.

## Trade-offs

### Beneficios
- **Resiliencia**: el sistema sigue siendo útil sin red.
- **Seguridad**: reglas claras y determinísticas en escenarios críticos.
- **Performance**: latencia cero en triaje offline.
- **Consistencia**: mismas reglas en Android e iOS (visión de core compartido).

### Costos / Riesgos
- Reglas locales requieren versionado y actualización periódica.
- El triaje offline es necesariamente más limitado que el online.
- Se debe comunicar claramente al usuario el alcance del resultado.

## Consecuencias
- El triaje se implementa como un módulo independiente (`TriageTool`) reutilizable.
- Se requiere un mecanismo futuro para actualizar reglas locales (fuera de alcance de la PoC).
- La UX debe contemplar mensajes claros de modo offline y limitaciones.
- La arquitectura cumple el requisito de operación bajo conectividad limitada sin comprometer seguridad.
